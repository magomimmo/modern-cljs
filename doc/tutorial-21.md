# Tutorial 21 - Learning by Contributing (Part 2)

In the [previous tutorial][1] while starting to learn the [Enfocus][2]
lib we ended up by collaborating with [Creighton Kirkendall][3] in
deeply refactoring both the directories layout and the `project.clj`
configuration of his very interesting and promising lib with the
intention of preparing it to be unit tested by using the
[clojurescript.test][4] lib.

## Preamble

If you did not type by yourself all the changes we made in the cloned
`Enfocus` during the [previous tutorial][1], I suggest you to start
working by first cloning the following repo which incorates the above
changes to the `Enfocus "2.0.0-SNAPSHOT"` release. Next `checkout` the
branch `tutorial-20` and finally create the new `tutorial-21` branch.

```bash
cd ~/dev
git clone https://github.com/magomimmo/enfocus.git
cd enfocus
git checkout tutorial-20
git checkout -b tutorial-21
```

## Introduction

The first instinct would be now to go on by starting to implement few
unit tests for the `enfocus` lib based on the [clojurescript.test][4]
unit testing lib. But we are going to postpone this topic to a next
tutorial for a couple of reasons:

* first, because to be able to define any unit tests for the `Enfocus`
  lib, we should at least know its basic use cases which we still have
  to learn about;
* second, because we want to anticipate few `project.clj` settings
  which affect the packaging of the `Enfocus` lib in a `jar` artifact
  to be published.

Therefore, in this tutorial we're going to improve even more the
directories layout and the `project.clj` file of the `Enfocus` lib by:

* preparing the lib to be correctly packaged in a `jar`;
* instrumenting the lib with [piggieback][5] lib;
* extending the application of the separations of concerns principle
  to the static resources of the project;
* publishing the modified `Enfocus` lib on [clojars][6];
* creating a very simple project which depends on the refactored
  `Enfocus` lib.

### Enfocus Packaging

In the [previous tutorial][1], while substituting the `cljx` plugin
with the `:crossovers` option of the `cljsbuild` plugin, we changed
the `:hooks [cljx.hooks]` setting with the `:hooks
[leiningen.cljsbuild]` setting as well.

This way the `cljsbuild` tasks have been hooked to the main `lein`
tasks. That's why we were able to issue the `lein do clean, compile`
chain of commands instead of the more verbose `lein do clean,
cljsbuild clean, cljsbuild once` one.

Following is the list of the supported `lein` main tasks when
`cljsbuild` is hooked to it:

```bash
* lein clean # calls lein cljsbuild clean task
* lein compile #call lein cljsbuild once task
* lein test # call lein cljsbuild test task
* lein jar
```

The first three hooked `lein` tasks have already been used and you
know about them. Let's now try the `lein jar` task by first take a
look at the associated help:

```bash
lein help jar
Package up all the project's files into a jar file.

Create a $PROJECT-$VERSION.jar file containing project's source files as well
as .class files if applicable. If project.clj contains a :main key, the -main
function in that namespace will be used as the main-class for executable jar.

With an argument, the jar will be built with an alternate main.

Arguments: ([main] [])
```

Good. the `lein jar` tasks seems to be exactly what we need to package
the `Enfocus` lib in a `jar` to be deployed and published on
[clojars][6].

Let's use it.

```bash
lein do clean, compile, jar
...
Created /Users/mimmo/tmp/enfocus/target/enfocus-2.1.0-SNAPSHOT.jar
```
Now take a look at content of the `enfocus-2.1.0-SNAPSHOT.jar` jar
package.

```bash
jar tvf target/enfocus-2.1.0-SNAPSHOT.jar
    92 Sat Nov 02 11:48:42 CET 2013 META-INF/MANIFEST.MF
  4554 Sat Nov 02 11:48:42 CET 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.xml
   165 Sat Nov 02 11:48:42 CET 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.properties
  1848 Sat Nov 02 11:48:42 CET 2013 META-INF/leiningen/org.clojars.magomimmo/enfocus/project.clj
  1848 Sat Nov 02 11:48:42 CET 2013 project.clj
     0 Sat Nov 02 11:48:10 CET 2013 public/
     0 Sat Nov 02 11:48:36 CET 2013 public/js/
119158 Sat Nov 02 11:48:34 CET 2013 public/js/advanced.js
715721 Sat Nov 02 11:48:26 CET 2013 public/js/simple.js
1316598 Sat Nov 02 11:48:36 CET 2013 public/js/whitespace.js
     0 Sat Nov 02 11:45:38 CET 2013 enfocus/
 23336 Sat Nov 02 11:45:38 CET 2013 enfocus/core.cljs
  6851 Sat Nov 02 11:45:28 CET 2013 enfocus/effects.cljs
  4247 Sat Nov 02 11:45:38 CET 2013 enfocus/events.cljs
     0 Sat Nov 02 11:45:38 CET 2013 enfocus/enlive/
  1928 Sat Nov 02 11:45:38 CET 2013 enfocus/enlive/syntax.clj
  4386 Sat Nov 02 11:45:28 CET 2013 enfocus/macros.clj
```

Oh my God. The emitted jar not only contains all the JS files
generated by the `cljsbuild`, but it doesn't even includes the CLJS
version of the `syntax.clj` file (i.e. `syntax.cljs`) and this is not
what we want.

Aside from the `META/INF` stuff and `project.clj` file, we would like
to package into the `Enfocus` jar only the source files and resources
needed by a third party developer to use the lib itself. More
precisely:

* the CLJ source files: `macros.clj` and `syntax.clj`
* the CLJS source files: `syntax.cljs`, `core.cljs`, `events.cljs` and
  `effects.cljs`.

A third party developer does not need any static resources (e.g. the
JS files generated by `cljsbuild`) to be able to use the `Enfocus`
lib, because those resources are used for testing purpose only.

### Fill the package with the right content

We'll go on step by step.

> ATTENTION NOTE
>
> In the [Tutorial 1 - The Basics][14] we already advised you that the
> `cljsbuild` plugin does not add back to the Leiningen `:source-paths`
> any pathnames from the `:source-paths` of each CLJS build. If you do
> not do this you can incur warnings and errors very difficult to catch.
> This is something that to me is not only very annoying, but even
> wrong. That said, at the moment we have to deal with this requirement.

#### Include the CLJS sources generated by `:crossovers`

To include the `syntax.cljs` file generated by the `:crossovers`
option the `cljsbuild`, all we have to do is just add to the
`cljsbuild` section the `:crossover-jar true` setting as well.

```clj
(defproject
  ...
  :cljsbuild
  {...
   :crossover-jar true
   ...})
```

Run the `lein jar` command again and inspect the emitted jar package.

```bash
lein jar
Compiling ClojureScript.
Created /Users/mimmo/devel/enfocus/target/enfocus-2.1.0-SNAPSHOT.jar
```

Here is the command to inspect the `jar` content.

```bash
jar tvf target/enfocus-2.1.0-SNAPSHOT.jar
...
  2105 Fri Oct 11 16:46:00 CEST 2013 enfocus/enlive/syntax.cljs
```

The `syntax.cljs` source is now included in the jar package. First
problem solved.

#### Include all the CLJS sources

The `cljsbuild` plugin offers a `:jar true` option which is settable
in each `build` of the `:builds` section. This is very similar to the
just used `:crossover-jar` option.

Even if the `cljsbuild` documentation says that, don't do it, because
we already added the CLJS pathnames to the Leiningen `:source-paths` and if
you follow the `cljsbuild` documentation the `lein jar` tasks will
raise a double entry error.

Don't you believe me? Try it.

```clj
(defproject
  ...
  :cljsbuild
  {...
   :builds {:whitespace
            {:source-paths ["src/cljs" "test/cljs"]
             :jar true ; DON'T DO THIS
             ...}}})
```

And now issue the `lein jar` command.

```bash
Giacomo-Cosenzas-iMac:enfocus mimmo$ lein jar
Compiling ClojureScript.
java.util.zip.ZipException: duplicate entry: enfocus/core.cljs
...
```

So, rollback by deleting the `:jar` option from the `:whitespace`
build.

#### Remove any generated JS sources

Let's now take care of the generated JS.

At the beginning of the [previous tutorial][1] we have shown the
*quasi standard directories layout* of a mixed CLJ/CLJS project and
talked a bit about the separation of concerns principle applied to the
static resources of a project.

In a CLJ/CLJS lib any static resource needed by a third party
developer to use the lib itself has to be parked in the `resources`
directory. Instead, any static resource needed during the
developing/testing phase of a lib has to be saved in the
`dev-resources` directory. This is because the `lein jar` command will
only include into the generated `jar` the resources registered in the
`resources` directory.

In the `Enfocus` project all the emitted JS files are used for testing
purpouse only, not for releasing the lib to third parties.

Let's then rename the `resources` directory as `dev-resources` and
modify any reference to it in the `project.clj`.

```bash
mv resources dev-resources
```

Here is the snippet of the modified portion of the `project.clj` file.

```clj
(defproject ...
  ...
  {...
   :builds {:whitespace
            {...
             :compiler
             {:output-to "dev-resources/public/js/whitespace.js"
              ...}}

            :simple
            {...
			 :compiler
             {:output-to "dev-resources/public/js/simple.js"
              ...}}

            :advanced
            {...
             :compiler
             {:output-to "dev-resources/public/js/advanced.js"
              ...}}}
   :test-commands {"whitespace"
                   ["phantomjs" :runner "dev-resources/public/js/whitespace.js"]

                   "simple"
                   ["phantomjs" :runner "dev-resources/public/js/simple.js"]

                   "advanced"
                   ["phantomjs" :runner "dev-resources/public/js/advanced.js"]}})
```

As you see, each `:output-to` and `:test-commands` setting are now
referencing the `dev-resources` directory.

Run the `lein jar` task again and inspect the emitted jar package.

```bash
lein jar
Compiling ClojureScript.
Created /Users/mimmo/devel/enfocus/target/enfocus-2.1.0-SNAPSHOT.jar
```

```bash
jar tvf target/enfocus-2.1.0-SNAPSHOT.jar
    92 Sat Nov 02 14:55:32 CET 2013 META-INF/MANIFEST.MF
  4554 Sat Nov 02 14:55:32 CET 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.xml
   165 Sat Nov 02 14:55:32 CET 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.properties
  1935 Sat Nov 02 14:55:32 CET 2013 META-INF/leiningen/org.clojars.magomimmo/enfocus/project.clj
  1935 Sat Nov 02 14:55:32 CET 2013 project.clj
     0 Sat Nov 02 11:45:38 CET 2013 enfocus/
 23336 Sat Nov 02 11:45:38 CET 2013 enfocus/core.cljs
  6851 Sat Nov 02 11:45:28 CET 2013 enfocus/effects.cljs
  4247 Sat Nov 02 11:45:38 CET 2013 enfocus/events.cljs
     0 Sat Nov 02 11:45:38 CET 2013 enfocus/enlive/
  1928 Sat Nov 02 11:45:38 CET 2013 enfocus/enlive/syntax.clj
  4386 Sat Nov 02 11:45:28 CET 2013 enfocus/macros.clj
  2103 Sat Nov 02 14:55:32 CET 2013 enfocus/enlive/syntax.cljs
```

Great. We now have a jar package which includes exactly what is needed
by a third party developer to use the `Enfocus` artifact.

Now commit your work before stepping ahead.

```bash
lein clean
git add .
git commit -am "fix the content to be packaged in the jar file"
```

## Instrument Enfocus

As a next step we'd like to instrument `Enfocus` with the
[piggieback][5] lib introduced in the
[Tutorial 19 - A survival guide for livin' on the edge][7] by adding
it to the `:dev` profile. We're also going to exploit this opportunity
to move few stuff to the `:dev` profile as well.

```clj
(defproject ...
  ...
  ;; piggieback requires a 2.2.0 minimun lein version
  :min-lein-version "2.2.0"
  ...
  ;; we moved the clojurescript.test lib into the dev profile
  :plugins [[lein-cljsbuild "1.0.0"]]
  ...

  :cljsbuild
  {:crossovers [enfocus.enlive.syntax]
   :crossover-jar true
   ;; we moved all the builds to support unit testing into the dev profile.
   ;; Here we only define the one used for including the lib CLJS source files
   ;; in the jar package.
   :builds {:deploy
            {:source-paths ["src/cljs"]
             ;:jar true ; DON'T TO THIS
             :compiler
             {:output-to "dev-resources/public/js/deploy.js"
              :optimizations :none
              :pretty-print false}}}}

  :profiles {:dev {:test-paths ["test/clj" "test/cljs"]

                   :dependencies [[com.cemerick/piggieback "0.1.2"]]
                   :plugins [[com.cemerick/clojurescript.test "0.2.1"]]

                   :cljsbuild
                   {:builds {:whitespace
                             {:source-paths ["src/cljs" "test/cljs"]
                              :compiler
                              {:output-to "dev-resources/public/js/whitespace.js"
                               :optimizations :whitespace
                               :pretty-print true}}

                             :simple
                             {:source-paths ["src/cljs" "test/cljs"]
                              :compiler
                              {:output-to "dev-resources/public/js/simple.js"
                               :optimizations :simple
                               :pretty-print false}}

                             :advanced
                             {:source-paths ["src/cljs" "test/cljs"]
                              :compiler
                              {:output-to "dev-resources/public/js/advanced.js"
                               :optimizations :advanced
                               :pretty-print false}}}

                    :test-commands {"whitespace"
                                    ["phantomjs" :runner "dev-resources/public/js/whitespace.js"]

                                    "simple"
                                    ["phantomjs" :runner "dev-resources/public/js/simple.js"]

                                    "advanced"
                                    ["phantomjs" :runner "dev-resources/public/js/advanced.js"]}}

                   :repl-options {:nrepl-middleware [cemerick.piggieback/wrap-cljs-repl]}
                   :injections [(require '[cljs.repl.browser :as brepl]
                                         '[cemerick.piggieback :as pb])
                                (defn browser-repl []
                                  (pb/cljs-repl :repl-env
                                                (brepl/repl-env :port 9000)))]}})
```

First we augmented the project with the `:dev` profile. Then we added
to it the `piggieback` instrumentation which requires the
`:repl-options` and the `:injections` setting as well.

Next we moved more stuff to the `:dev` profile:

* the `:test-paths` option because it will be used for testing purpose
  only;
* the `clojurescript.test` lib into the `:plugins` section of the
  `:dev` profile, because it will be used for testing purpose only;
* the three builds (i.e. `:whitespace`, `:simple` and `:advanced`),
  because they will be used for testing purpose only;
* the three `:test-commands` (i.e. `"whitespace"`, `"simple"` and
  `"advanced"`) becasue they are used for testing purpose only.

Finally we added a `:deploy` build in the `:builds` section out of the
`:dev` profile. This build is only used for including into the `jar`
the files contained in its `:source-paths` pathnames. Note that to
speed up a little bit its useless compilation we declared its compiler
`:optimizations` to be `:none`.

> NOTE 2: the `org.clojars.magomimmo` group-id is used to deploy the
> `Enfocus` artifact to clojars by respecting its guide lines. This
> artifact is said to be a non canonical one, because is a fork of the
> canonical one

> NOTE 3: Because of `piggieback` requirements, we needed to update
> the `min-lein-version` setting to `"2.2.0"`.

> NOTE 4: For a more detailed explanation of the `piggieback`
> instrumentation and the addition of the `:profiles` setting, see the
> [Tutorial 18 - Housekeeping][8] tutorial.

### Light the fire

We can now try to run everything from scratch to verity if the
changes altered the result.

```bash
lein do clean, compile, jar
...
Created /Users/mimmo/tmp/enfocus/target/enfocus-2.1.0-SNAPSHOT.jar
```

```bash
jar tvf target/enfocus-2.1.0-SNAPSHOT.jar
    92 Sat Nov 02 17:15:12 CET 2013 META-INF/MANIFEST.MF
  4790 Sat Nov 02 17:15:12 CET 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.xml
   165 Sat Nov 02 17:15:12 CET 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.properties
  3172 Sat Nov 02 17:15:12 CET 2013 META-INF/leiningen/org.clojars.magomimmo/enfocus/project.clj
  3172 Sat Nov 02 17:15:12 CET 2013 project.clj
     0 Sat Nov 02 11:45:38 CET 2013 enfocus/
 23336 Sat Nov 02 11:45:38 CET 2013 enfocus/core.cljs
  6851 Sat Nov 02 11:45:28 CET 2013 enfocus/effects.cljs
  4247 Sat Nov 02 11:45:38 CET 2013 enfocus/events.cljs
     0 Sat Nov 02 11:45:38 CET 2013 enfocus/enlive/
  1928 Sat Nov 02 11:45:38 CET 2013 enfocus/enlive/syntax.clj
  4386 Sat Nov 02 11:45:28 CET 2013 enfocus/macros.clj
  2103 Sat Nov 02 17:15:12 CET 2013 enfocus/enlive/syntax.cljs
```

Great. The project is still compiling and generating the `jar` package
as expected. We should now predispose the `Enfocus` project, already
instrumented with `piggieback`, to connect itself to the browser JS
engine as we explained in the [Tutorial 18 - Housekeeping][8].

## Postpone the bREPL connection

As you remember there are more step to be done:

* create and run an http server to respect the
  [same origin policy][9];
* create a cljs source file to create the bREPL connection;
* create an html page which includes the link to the bREPL connection;
* launch the `lein repl` task from the main project directory;
* call the `(browser-repl)` function from the CLJ REPL;
* visit the above html page;
* use the bREPL.

We're going to pospone all this stuff to the end of this tutorial
because we first want to deploy the revised `Enfocus` lib to `clojars`
and try to use it in a very simple new project to verify that even
after all the changes we did, the `Enfocus` lib is still working as
expected.

## Deploy on clojars

Let's deploy the new `2.1.0-SNAPSHOT` artifact to `clojars`:

```bash
lein deploy clojars
No credentials found for clojars (did you mean `lein deploy clojars`?)
See `lein help deploy` for how to configure credentials.
Username: ********
Password: ********
Wrote /Users/mimmo/tmp/enfocus/pom.xml
Compiling ClojureScript.
Created /Users/mimmo/tmp/enfocus/target/enfocus-2.1.0-SNAPSHOT.jar
Retrieving org/clojars/magomimmo/enfocus/2.1.0-SNAPSHOT/maven-metadata.xml (1k)
    from https://clojars.org/repo/
Sending org/clojars/magomimmo/enfocus/2.1.0-SNAPSHOT/enfocus-2.1.0-20131102.162933-6.pom (5k)
    to https://clojars.org/repo/
Sending org/clojars/magomimmo/enfocus/2.1.0-SNAPSHOT/enfocus-2.1.0-20131102.162933-6.jar (17k)
    to https://clojars.org/repo/
Retrieving org/clojars/magomimmo/enfocus/maven-metadata.xml (1k)
    from https://clojars.org/repo/
Sending org/clojars/magomimmo/enfocus/2.1.0-SNAPSHOT/maven-metadata.xml (1k)
    to https://clojars.org/repo/
Sending org/clojars/magomimmo/enfocus/maven-metadata.xml (1k)
    to https://clojars.org/repo/
```

Good. It worked too.

## Test with a simple project

We did a lot of working by refactoring the directories layout of
`Enfocus` and by deeply altering its project configuration, but we did
not even touch a single line of its codebase. So, we should expect
that we can still create a very simple project which depends on the
revisited `Enfocus` lib without incurring in any trouble.

### Create a new project

First create a new lein project.

```bash
lein new hello-enfocus
cd hello-enfocus
```

Then edit its `project.clj` as follows:

```clj
(defproject hello-enfocus "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :min-lein-version "2.2.0"
  :source-paths ["src/clj"]
  :dependencies [[org.clojure/clojure "1.5.1"]
                 [org.clojure/clojurescript "0.0-2069"]
                 [org.clojars.magomimmo/enfocus "2.1.0-SNAPSHOT"]]
  :plugins [[lein-cljsbuild "1.0.0"]]

  :cljsbuild {:builds {:whitespace
                       {:source-paths ["src/cljs"]
                        :compiler
                        {:output-to "resources/public/js/hello.js"
                         :optimizations :whitespace
                         :pretty-print true}}}})
```

Now reorganize the directories layout by following the *quasi standard
directories layout* we introduced at the beginning of the
[previous tutorial][1].

```bash
mkdir -p src/{cljs/hello_enfocus,clj}
mv src/hello_enfocus src/clj
```

Now create the `core.cljs` file in the `src/cljs/hello-enfocus`
directory with the following content:

```clj
(ns hello-enfocus.core
  (:require [enfocus.core :as ef]
            [enfocus.events :as events]
	    [enfocus.effects :as effects])
  (:require-macros [enfocus.macros :as em]))

(defn start []
  (ef/at js/document
    ["body"] (ef/content "Hello Enfocus!")))

(set! (.-onload js/window) start)
```

Next compile it as usual.

```bash
lein cljsbuild once
Compiling ClojureScript.
Retrieving org/clojars/magomimmo/enfocus/2.1.0-SNAPSHOT/enfocus-2.1.0-20131102.162933-6.pom from clojars
Retrieving org/clojars/magomimmo/enfocus/2.1.0-SNAPSHOT/enfocus-2.1.0-20131102.162933-6.jar from clojars
Compiling "resources/public/js/hello.js" from ["src/cljs"]...
Successfully compiled "resources/public/js/hello.js" in 8.833661 seconds.
```

Then create the `hello.html` file in the `resources/public` directory
with the following content:

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hello, Enfocus!</title>
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <!-- pointing to cljsbuild generated js file -->
    <script src="js/hello.js"></script>
</body>
</html>
```

Now open the `~/dev/hello-enfocus/resources/public/hello.html` file
in your browser and you should see the `Hello, Enfocus!` string
shown in the page.

## bREPL Connection

Let's now go back to `Enfocus`, becasue it's now time for
instrumenting on by `Enfocus` for REPLing with the browser.

## Add and configure `ring` and `compojure`

First we need to install and run an HTTP server as we did in the
[Tutorial 3 - CLJ based http-server][10]. This time, instead of using
the `lein-ring` plugin, which automates most of the `ring` tasks, we
are going to use it as a lib in the dependencies section of the `:dev`
profile.

```clj
(defproject ...
  ...
  :profiles {:dev {...
                   :dependencies [...
                                  [ring "1.2.1"]
                                  [compojure "1.1.6"]]
                   ...}})
```

We now have to define the `compojure` routes and a function for
running the server.

By taking into account that the HTTP server will be used by `Enfocus`
for development and testing scopes only, we are going to define the
routes and the function to run the server in the
`dev-resources/enfocus` directory. This is because `lein` adds the
`dev-resources` directory to the project `classpath`.

```clj
;;; test/clj/enfocus/server.clj
(ns enfocus.server
  (:require [compojure.core :refer (GET defroutes)]
            [compojure.route :refer  (resources not-found)]
            [ring.util.response :refer (redirect)]
            [ring.adapter.jetty :as jetty]))

;; defroutes macro defines a function that chains individual route
;; functions together. The request map is passed to each function in
;; turn, until a non-nil response is returned.
(defroutes site
  ; to serve document root address
  (GET "/" [] (redirect "/index.html"))
  ; to serve static pages saved in dev-resources/public directory
  (resources "/")
  ; if page is not found
  (not-found "Page not found"))

(defn run
  []
  (defonce server
    (jetty/run-jetty #'site {:port 3000 :join? false}))
  server)
```

Here the only news, if compared with what we did in the
[Tutorial 3 - CLJ based http-server][10], is the definition of the
`run` function which will be used to programmatically start the HTTP
server from the `REPL` on port `3000`.

> NOTE 5: The `:join? false` setting is used to return the control to
> the REPL after the server started. The `defonce` macro is used to
> bind the `server` symbol to the HTTP server and can't be rebind to
> other values.

As you see, we defined the HTTP root "/" to redirect to the
`index.html` URL. This is the page that we're now going to create into
the `dev-resources/public` directory for predisposing the connection
of the bREPL with the browser.

### Create the HTML connection page

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>bREPL Connection</title>
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <!-- pointing to cljsbuild generated js file -->
    <script src="js/whitespace.js"></script>
</body>
</html>
```

> NOTE 6: We linked the script tag to `"js/whitespace.js"`
> source. You'll discover later the reason why.

### Create the bREPL connection

The next step is to create the `cljs` file that is going to predispose
the connection with the browser in the same way we did in the
[Tutorial 2 - Browser CLJS REPL (bREPL)][11]. By remembering that we
can activate the bREPL connection with the `:whitespace` or `:simple`
optimizations only, and that we don't want to have the bREPL
connection to be included into the `jar` package to be deployed, we're
going to create the `connect.cljs` source file in the new
`src/brepl/enfocus` directory.

```bash
mkdir -p src/brepl/enfocus
```

```clj
;;; connect.cljs
(ns enfocus.connect
  (:require [clojure.browser.repl :as repl]))

(repl/connect "http://localhost:9000/repl")
```

### Add the bREPL connection to the builds

To summarize, we added and configured in the `dev-resources` directory
the HTTP server to serve the `index.html` page. This page has been
created in the `dev-resources` directory path too, because it is used
in development and testing scenarios only. We also created the
`connect.cljs` file in the `src/brepl/enfocus` directory path to keep
it separated from the rest of the codebase.

As next step we need to instruct `cljsbuild` to include the
`connect.cljs` from the `src/brepl/enfocus` directory during the
compilation of the `whitespace` build which is linked to the
`index.html` page.

```clj
(defproject
  ...
  :profiles {:dev {:resources-paths ["dev-resources"]
                   ...
                   :cljsbuild
                   {:builds {:whitespace
                             {:source-paths ["src/cljs" "test/cljs" "src/brepl"]
                              :compiler
                              {:output-to "dev-resources/public/js/whitespace.js"
                               :optimizations :whitespace
                               :pretty-print true}}
                             ...}
                    ...}
                   ...}})
```

> NOTE 7: We added the `:resource-paths ["dev-resources"]` setting to
> instruct the HTTP server about its root directory. If we don't do
> this the `ring` server is going to look by default to the
> `resources` directory.

### Light the fire

We're now ready to verify that everything is still working as expected
and then try to establish the connection between the REPL and the
browser.

```bash
lein do clean, compile
...
Successfully compiled "dev-resources/public/js/whitespace.js" in 9.380374 seconds.
...
Successfully compiled "dev-resources/public/js/advanced.js" in 12.129392 seconds.
...
Successfully compiled "dev-resources/public/js/simple.js" in 6.99072 seconds.
Compiling "dev-resources/public/js/deploy.js" from ["src/cljs"]...
Successfully compiled "dev-resources/public/js/deploy.js" in 2.519635 seconds.
```

Great. The project is still compiling as we expected and you can
verify that the `whitespace.js` script is compiled down by reading the
`src/brepl` directory path too.

Now let's see of the unit test is still working.

```bash
lein test
Compiling ClojureScript.

lein test enfocus.server

Ran 0 tests containing 0 assertions.
0 failures, 0 errors.
Running all ClojureScript tests.

Testing enfocus.core-test

FAIL in (empty-test) (:)
expected: (= 0 1)
  actual: (not (= 0 1))

Ran 1 tests containing 1 assertions.
1 failures, 0 errors.
{:test 1, :pass 0, :fail 1, :error 0, :type :summary}

Testing enfocus.core-test

FAIL in (empty-test) (:)
expected: (= 0 1)
  actual: (not (= 0 1))

Ran 1 tests containing 1 assertions.
1 failures, 0 errors.
{:test 1, :pass 0, :fail 1, :error 0, :type :summary}

Testing enfocus.core-test

FAIL in (empty-test) (:)
expected: (= 0 1)
  actual: (not (= 0 1))

Ran 1 tests containing 1 assertions.
1 failures, 0 errors.
{:test 1, :pass 0, :fail 1, :error 0, :type :summary}
Subprocess failed
```

Great. The three `:test-commands` (i.e. `"whitespace"`, `"simple"` and
`"advanced"`) are still working. As you remember we defined just a
failing unit test to remember us that we still have to define unit
tests for `Enfocus`.

### Enfocus bREPLing

As a last step let's run the HTTP server and the bREPL from the
standard REPL and see if we're able to repl against `enfocus`.

First, launch the REPL

```bash
lein repl
Compiling ClojureScript.
nREPL server started on port 51012 on host 127.0.0.1
REPL-y 0.2.1
Clojure 1.5.1
    Docs: (doc function-name-here)
          (find-doc "part-of-name-here")
  Source: (source function-name-here)
 Javadoc: (javadoc java-object-or-class-here)
    Exit: Control+D or (exit) or (quit)

user=>
```

Then start the `ring` server as follows>

```clj
user=> (require '[enfocus.server :as http])
nil
user=> (http/run)
2013-10-24 18:32:05.463:INFO:oejs.Server:jetty-7.6.8.v20121106
2013-10-24 18:32:05.498:INFO:oejs.AbstractConnector:Started SelectChannelConnector@0.0.0.0:3000
#<Server org.eclipse.jetty.server.Server@6b3a19e3>
user=>
```

To stop and restart the `ring` server you can issue the following
commands

```clj
user=> (.stop http/server)
nil
user=> (.start http/server)
2013-10-24 18:34:34.105:INFO:oejs.Server:jetty-7.6.8.v20121106
2013-10-24 18:34:34.105:INFO:oejs.AbstractConnector:Started SelectChannelConnector@0.0.0.0:3000
nil
user=>
```

To create the bREPL connection just call the `browser-repl` we
instrumented with `piggieback` from the active REPL.

```clj
user=> (browser-repl)
Type `:cljs/quit` to stop the ClojureScript REPL
nil
cljs.user=>
```

and visit the [localhost:3000][12] URL. Wait a moment to allow the
bREPL to connect with the JS engine of your browser and then start
repling with `Enfocus`.

```clj
cljs.user=> (+ 41 1)
42
cljs.user=>
```

Now quit the bREPL, exit the CLJ REPL and launch the `lein jar` and
the `jar tvf` commands to verify that the packaging is still correct.

```clj
cljs.user=> :cljs/quit
:cljs/quit
user=> exit
Bye for now!
```

```bash
lein jar
Compiling ClojureScript.
Created /Users/mimmo/tmp/enfocus/target/enfocus-2.1.0-SNAPSHOT.jar

jar tvf target/enfocus-2.1.0-SNAPSHOT.jar
    92 Sat Nov 02 18:24:46 CET 2013 META-INF/MANIFEST.MF
  5116 Sat Nov 02 18:24:46 CET 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.xml
   165 Sat Nov 02 18:24:46 CET 2013 META-INF/maven/org.clojars.magomimmo/enfocus/pom.properties
  3341 Sat Nov 02 18:24:46 CET 2013 META-INF/leiningen/org.clojars.magomimmo/enfocus/project.clj
  3341 Sat Nov 02 18:24:46 CET 2013 project.clj
     0 Sat Nov 02 11:45:38 CET 2013 enfocus/
 23336 Sat Nov 02 11:45:38 CET 2013 enfocus/core.cljs
  6851 Sat Nov 02 11:45:28 CET 2013 enfocus/effects.cljs
  4247 Sat Nov 02 11:45:38 CET 2013 enfocus/events.cljs
     0 Sat Nov 02 11:45:38 CET 2013 enfocus/enlive/
  1928 Sat Nov 02 11:45:38 CET 2013 enfocus/enlive/syntax.clj
  4386 Sat Nov 02 11:45:28 CET 2013 enfocus/macros.clj
  2103 Sat Nov 02 18:24:46 CET 2013 enfocus/enlive/syntax.cljs
```

Great. As usual, it's now time to commit your work.

```bash
git add .
git commit -am "Instrumented"
```

Stay tuned for the next tutorial.

# Next Step - [Tutorial 22 - Learn by Contributing (Part 3)][13]

In the [next tutorial][13] we're going to improve `Enfocus` even more,
by applying again the separation of concerns principle and by starting
to implement few unit tests which follow my personal strategy when
unit testing. In doing that we'll discover few bugs in the codebase
and we even correct them by first interact with the REPL.

# License

Copyright Â© Mimmo Cosenza, 2012-14. Released under the Eclipse Public
License, the same as Clojure.

[1]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-20.md
[2]: https://github.com/ckirkendall/enfocus
[3]: https://github.com/ckirkendall
[4]: https://github.com/cemerick/clojurescript.test
[5]: https://github.com/cemerick/piggieback
[6]: https://clojars.org/
[7]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-19.md
[8]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-18.md
[9]: http://en.wikipedia.org/wiki/Same_origin_policy
[10]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-03.md
[11]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-02.md
[12]: http://localhost:3000/
[13]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-22.md
[14]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-01.md
