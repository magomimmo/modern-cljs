# Tutorial 2 - Browser CLJS REPL (bREPL)

In this tutorial you are going to set up a browser connected CLJS REPL
(bRepl) using an external http-server.

## Introduction

One of the main reason to use a LISP dialect like CLJ is its REPL (Real
Eval Print Loop), which enables a very interactive style of
programming. CLJS communities worked a lot to bring the same REPL-based
programming experience in CLJS, creating a way to connect a CLJS REPL to
the JS engine embedded in the browser. This style of programming allows
you to evaluate CLJS forms in the REPL and have immediate feedback in the
browser to which the REPL is connected.

Due to browser imposed limitations to prevent [cross site scripting][1]
attacks, the REPL connection with the browser embedded JS engine has to
be set up respecting the [Same Origin Policy][2]. This means that, if we
want to enable a browser connected CLJS REPL (brepl), we need to set up
a local http-server.

You can use any http-server. In this tutorial we're going to use the
[apache http-server][3], which is included in [MAMP][4] for Mac OS X
operating system, because it's very easy to be configured and run. There
should be similar options for others OSs.

> NOTE 1: a very handy and portable http-server is python module
> `SimpleHTTPServer`. If you have python installed on your operating
> system just launch it as follows:
>
> ```bash
> $ cd /path/to/modern-cljs/resources/public
> $ python -m SimpleHTTPServer 8888
> Serving HTTP on 0.0.0.0 port 8888 ...
> ```
>
> Thanks to [Max Penet][5] for the suggestion.

## Install, configure and run MAMP

Follow MAMP documentation to install MAMP. Start MAPM and click the
Preferences button of its Admin GUI.

![MAMP Admin Panel][6]

Then click the Apache tab to choose
`/path/to/modern-cljs/resources/public` as root directory of your local
Apache http server. Click ok. Finally click `Start Servers` button to
start everything. Now you have a local web server running on your
machine at port `8888`. Visit [simple.html][7] you create in
[Tutorial 1 - The Basic][8] to verify that everything it's ok.

## Setting a browser connected CLJS REPL (brepl)

To setting a brepl, we need to follow few steps:

* create a CLJS file to create the connection between the browser and
  the brepl
* compile the CLJS file
* start the brepl server
* enable the connection

### Create the connection

Create a CLJS source file in the `src/cljs/modern_cljs` with the
following content:

```clojure
(ns modern-cljs.connect
  (:require [clojure.browser.repl :as repl]))

(repl/connect "http://localhost:9000/repl")
```

Save the file as `connect.cljs`.

As you can see, to connect from the browser to the brepl we have to call
the `connect` function defined in the `clojure.browser.repl`
namespace. We set `9000` as a port of the brepl to be connected to,
because this is the default port used by the brepl server when we'll
start it.

### Compile the CLJS file

Now we need compile the new CLJS file. [Google Closure Compiler][9] (CLS)
has few compilation options we already set up in our `project.clj`
during [Tutorial 1][8] and we can leave that options as we have already
configured. Now Call the CLJS compilation task:

```bash
$ lein cljsbuild once
Compiling ClojureScript.
Compiling "resources/public/js/modern.js" from "src/cljs"...
Successfully compiled "resources/public/js/modern.js" in 4.904672 seconds.
$
```
### Start a brepl

To enable the connection between the repl and the browser, we need
to start a repl that acts as a server waiting for a connection from the
browser. To do that we're going to use a `repl-listen` task already
set up by `lein-cljsbuild` for us.

```bash
$ lein trampoline cljsbuild repl-listen
Running ClojureScript REPL, listening on port 9000.
"Type: " :cljs/quit " to quit"
ClojureScript:cljs.user>
```

Do not type anything at the brepl prompt, because it's waiting for a
connection from the browser and it's not yet responsive.

### Enable the connection

To enable the browser connection with the running brepl we just need to
visit the [simple.html][7] we created in the prevoius [Tutorial 1][8].

Obviously, the http-server has to be running. By visiting
[simple.html][7] page, the included `modern.js` script generated by CLS
compilation connects to the listening brepl on port `9000` started by
`repl-listen` task of `lein-cljsbuild` plugin.

Now you can evaluate CLJS forms in the brepl.

```clojure
ClojureScript:cljs.user> (+ 41 1)
42
ClojureScript:cljs.user>
```
Best of all, you can start evaluting CLJS forms interacting with the browser
and see immediate feedback in the browser itself.

```clojure
ClojureScript:cljs.user> (js/alert "Hello from a browser connected repl")
```
![Alert Window][10]

## Next step

In the next [tutorial][11] we're going to substitute the external
http-server with a CLJ based http-server in such a way that in others
tutorial we'll implement a direct communications between CLJS client
code and CLJ server code.

# License

Copyright Â© Mimmo Cosenza, 2012-2013. Released under the Eclipse Public
License, the same as Clojure.

[1]: http://en.wikipedia.org/wiki/Cross-site_scripting
[2]: http://en.wikipedia.org/wiki/Same_origin_policy
[3]: http://httpd.apache.org/
[4]: http://www.mamp.info/en/index.html
[5]: https://github.com/mpenet
[6]: https://raw.github.com/magomimmo/modern-cljs/master/doc/images/mamp-01.png
[7]: http://localhost:8888/simple.html
[8]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-01.md
[9]: https://developers.google.com/closure/compiler/
[10]: https://raw.github.com/magomimmo/modern-cljs/master/doc/images/alert.png
[11]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-03.md
